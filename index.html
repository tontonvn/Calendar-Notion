<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Notion連携対応の高機能カレンダーウィジェット" />
  <title>Calendar Widget for Notion</title>
  <style>
    /* ダークモード対応のCSS変数 */
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #6b7280;
      --accent: #3b82f6;
      --today-bg: #111111;
      --today-fg: #ffffff;
      --danger: #dc2626;
      --success: #16a34a;
      --card: #f8fafc;
      --card2: #f1f5f9;
      --ring: #e2e8f0;
      --hover: #f1f5f9;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --fg: #f1f5f9;
        --muted: #94a3b8;
        --accent: #60a5fa;
        --today-bg: #3b82f6;
        --today-fg: #ffffff;
        --danger: #ef4444;
        --success: #22c55e;
        --card: #1e293b;
        --card2: #334155;
        --ring: #334155;
        --hover: #334155;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.25);
        --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.25);
        --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.25);
      }
    }

    /* ベーススタイル */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
      font-size: 16px;
    }

    body {
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 
                   "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", 
                   "Yu Gothic", Meiryo, sans-serif;
      line-height: 1.6;
      color: var(--fg);
      background: var(--bg);
      font-variant-numeric: tabular-nums;
      transition: background-color 0.3s ease;
    }

    /* コンテナ */
    .widget {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* トップバー */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.25rem;
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 1rem;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .topbar:hover {
      box-shadow: var(--shadow);
    }

    .clock-container {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .clock {
      font-weight: 700;
      font-size: 1.25rem;
      letter-spacing: 0.025em;
      font-feature-settings: "tnum";
    }

    .timezone {
      font-size: 0.75rem;
      color: var(--muted);
      font-weight: 500;
    }

    /* 天気情報 */
    .weather {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: var(--card2);
      border-radius: 0.75rem;
      transition: var(--transition);
    }

    .weather:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .weather-icon {
      font-size: 1.75rem;
      line-height: 1;
      filter: saturate(1.2);
    }

    .weather-info {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .weather-temp {
      font-weight: 700;
      font-size: 1rem;
    }

    .weather-desc {
      font-size: 0.75rem;
      color: var(--muted);
      font-weight: 500;
    }

    /* ツールバー */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .nav-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2.5rem;
      height: 2.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 0.75rem;
      font-weight: 600;
      color: var(--fg);
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
      font-size: 0.875rem;
    }

    .btn:hover {
      background: var(--hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn.primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .btn.primary:hover {
      filter: brightness(1.1);
    }

    .month-title {
      font-weight: 800;
      font-size: 1.25rem;
      padding: 0 0.75rem;
      min-width: 10rem;
      text-align: center;
    }

    /* レジェンド */
    .legend {
      display: flex;
      gap: 1rem;
      align-items: center;
      font-size: 0.8125rem;
      color: var(--muted);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .legend-dot {
      width: 0.625rem;
      height: 0.625rem;
      border-radius: 50%;
      background: var(--fg);
      flex-shrink: 0;
    }

    .legend-dot.weekend {
      background: var(--danger);
    }

    .legend-dot.holiday {
      background: var(--success);
    }

    .legend-dot.today {
      background: var(--accent);
    }

    /* カレンダーテーブル */
    .calendar {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0.375rem;
    }

    .calendar thead th {
      text-align: center;
      padding: 0.75rem 0;
      color: var(--muted);
      font-weight: 700;
      font-size: 0.8125rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .calendar thead th.weekend {
      color: var(--danger);
    }

    .calendar tbody td {
      vertical-align: top;
      padding: 0;
    }

    /* 日付セル */
    .day {
      position: relative;
      aspect-ratio: 1 / 1.1;
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 0.875rem;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
    }

    .day.empty {
      background: transparent;
      border-color: transparent;
      cursor: default;
    }

    .day:not(.empty):hover {
      background: var(--hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      z-index: 10;
    }

    .day:not(.empty):active {
      transform: translateY(-1px);
    }

    .day-link {
      position: absolute;
      inset: 0;
      text-decoration: none;
      z-index: 1;
    }

    .day-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      position: relative;
      z-index: 2;
    }

    .day-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2ch;
      padding: 0.25rem 0.375rem;
      font-weight: 800;
      font-size: 0.9375rem;
      line-height: 1;
      border-radius: 0.5rem;
      color: var(--fg);
      transition: var(--transition);
    }

    .day.is-weekend .day-number {
      color: var(--danger);
    }

    .day.is-holiday .day-number {
      color: var(--success);
      font-weight: 900;
    }

    .day.is-today .day-number {
      background: var(--accent);
      color: white;
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.85;
      }
    }

    .day-indicators {
      display: flex;
      gap: 0.125rem;
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
    }

    .indicator {
      width: 0.25rem;
      height: 0.25rem;
      border-radius: 50%;
      background: var(--accent);
    }

    .day-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
      font-size: 0.625rem;
      color: var(--muted);
      position: relative;
      z-index: 2;
    }

    .holiday-name {
      font-weight: 600;
      color: var(--success);
      font-size: 0.6875rem;
      line-height: 1.2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ローディング状態 */
    .loading {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--muted);
      font-size: 0.875rem;
    }

    .spinner {
      width: 1rem;
      height: 1rem;
      border: 2px solid var(--ring);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* エラー状態 */
    .error {
      padding: 0.75rem 1rem;
      background: var(--danger);
      color: white;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* レスポンシブ対応 */
    @media (max-width: 640px) {
      .widget {
        padding: 0.75rem;
      }

      .topbar {
        flex-direction: column;
        gap: 0.75rem;
        padding: 0.875rem;
      }

      .month-title {
        font-size: 1rem;
        min-width: auto;
      }

      .toolbar {
        flex-direction: column;
        gap: 0.75rem;
      }

      .calendar {
        border-spacing: 0.25rem;
      }

      .day {
        padding: 0.375rem;
        border-radius: 0.625rem;
      }

      .day-number {
        font-size: 0.8125rem;
      }

      .holiday-name {
        display: none;
      }

      .legend {
        font-size: 0.75rem;
        justify-content: center;
      }
    }

    /* アニメーション無効化（アクセシビリティ） */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* プリント対応 */
    @media print {
      .weather,
      .clock-container,
      .btn {
        display: none;
      }

      .day:not(.empty) {
        break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="widget" id="app">
    <!-- トップバー -->
    <div class="topbar">
      <div class="clock-container">
        <div class="clock" id="clock" aria-live="polite" aria-atomic="true">--:--:--</div>
        <div class="timezone" id="timezone"></div>
      </div>
      <div class="weather" id="weather" role="region" aria-label="天気情報">
        <div class="weather-icon" id="weather-icon" aria-hidden="true">⛅</div>
        <div class="weather-info">
          <div class="weather-temp" id="weather-temp">--°C</div>
          <div class="weather-desc" id="weather-desc">読み込み中...</div>
        </div>
      </div>
    </div>

    <!-- ツールバー -->
    <div class="toolbar">
      <div class="nav-group">
        <button class="btn" id="prev-month" aria-label="前の月へ" title="前の月へ">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <h1 class="month-title" id="month-title">Month YYYY</h1>
        <button class="btn" id="next-month" aria-label="次の月へ" title="次の月へ">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
      <div class="nav-group">
        <button class="btn primary" id="today-btn" aria-label="今日へ移動" title="今日へ移動">
          今日
        </button>
        <div class="legend" role="presentation">
          <span class="legend-item">
            <span class="legend-dot"></span>
            <span>平日</span>
          </span>
          <span class="legend-item">
            <span class="legend-dot weekend"></span>
            <span>週末</span>
          </span>
          <span class="legend-item">
            <span class="legend-dot holiday"></span>
            <span>祝日</span>
          </span>
          <span class="legend-item">
            <span class="legend-dot today"></span>
            <span>今日</span>
          </span>
        </div>
      </div>
    </div>

    <!-- カレンダー -->
    <table class="calendar" role="grid" aria-label="月間カレンダー">
      <thead>
        <tr role="row">
          <th role="columnheader" scope="col">月</th>
          <th role="columnheader" scope="col">火</th>
          <th role="columnheader" scope="col">水</th>
          <th role="columnheader" scope="col">木</th>
          <th role="columnheader" scope="col">金</th>
          <th role="columnheader" scope="col" class="weekend">土</th>
          <th role="columnheader" scope="col" class="weekend">日</th>
        </tr>
      </thead>
      <tbody id="calendar-grid"></tbody>
    </table>

    <!-- エラー表示エリア -->
    <div id="error-container"></div>
  </div>

  <script>
    // 設定
    const CONFIG = {
      NOTION_URL: 'https://www.notion.so/your-calendar-page',
      APPEND_DATE_QUERY: true,
      HOLIDAY_API_URL: (year) => `https://holidays-jp.github.io/api/v1/${year}/date.json`,
      WEATHER_API_URL: 'https://api.open-meteo.com/v1/forecast',
      WEATHER_UPDATE_INTERVAL: 600000, // 10分
      CLOCK_UPDATE_INTERVAL: 1000,
      WEATHER_TIMEOUT: 3000,
      DEFAULT_COORDS: [35.681236, 139.767125], // Tokyo
      TIMEZONE_COORDS: {
        'Asia/Tokyo': [35.681236, 139.767125],
        'Asia/Seoul': [37.5665, 126.9780],
        'Asia/Taipei': [25.0375, 121.5637],
        'Asia/Shanghai': [31.2304, 121.4737],
        'Asia/Hong_Kong': [22.3193, 114.1694],
        'Asia/Singapore': [1.3521, 103.8198],
        'Europe/London': [51.5074, -0.1278],
        'Europe/Paris': [48.8566, 2.3522],
        'Europe/Berlin': [52.5200, 13.4050],
        'America/New_York': [40.7128, -74.0060],
        'America/Los_Angeles': [34.0522, -118.2437],
        'America/Chicago': [41.8781, -87.6298]
      }
    };

    // ユーティリティ関数
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    const pad = (n) => String(n).padStart(2, '0');
    const formatDate = (date) => `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;

    // 状態管理
    class CalendarState {
      constructor() {
        this.currentDate = new Date();
        this.selectedYear = this.currentDate.getFullYear();
        this.selectedMonth = this.currentDate.getMonth();
        this.holidays = new Map();
        this.weatherData = null;
        this.coords = null;
      }

      setYearMonth(year, month) {
        this.selectedYear = year;
        this.selectedMonth = month;
      }

      goToToday() {
        const today = new Date();
        this.selectedYear = today.getFullYear();
        this.selectedMonth = today.getMonth();
      }

      goToPrevMonth() {
        if (this.selectedMonth === 0) {
          this.selectedMonth = 11;
          this.selectedYear--;
        } else {
          this.selectedMonth--;
        }
      }

      goToNextMonth() {
        if (this.selectedMonth === 11) {
          this.selectedMonth = 0;
          this.selectedYear++;
        } else {
          this.selectedMonth++;
        }
      }
    }

    // エラー処理
    class ErrorHandler {
      static show(message) {
        const container = $('#error-container');
        const errorEl = document.createElement('div');
        errorEl.className = 'error';
        errorEl.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <span>${message}</span>
        `;
        container.appendChild(errorEl);
        
        setTimeout(() => {
          errorEl.remove();
        }, 5000);
      }
    }

    // 時計機能
    class Clock {
      constructor() {
        this.clockEl = $('#clock');
        this.timezoneEl = $('#timezone');
        this.intervalId = null;
      }

      start() {
        this.updateTimezone();
        this.update();
        this.intervalId = setInterval(() => this.update(), CONFIG.CLOCK_UPDATE_INTERVAL);
      }

      stop() {
        if (this.intervalId) {
          clearInterval(this.intervalId);
          this.intervalId = null;
        }
      }

      update() {
        const now = new Date();
        const hours = pad(now.getHours());
        const minutes = pad(now.getMinutes());
        const seconds = pad(now.getSeconds());
        this.clockEl.textContent = `${hours}:${minutes}:${seconds}`;
      }

      updateTimezone() {
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
        this.timezoneEl.textContent = `${timezone} • 24時間表示`;
      }
    }

    // 天気機能
    class Weather {
      constructor(state) {
        this.state = state;
        this.iconEl = $('#weather-icon');
        this.tempEl = $('#weather-temp');
        this.descEl = $('#weather-desc');
        this.intervalId = null;
      }

      async init() {
        await this.getCoordinates();
        await this.update();
        this.intervalId = setInterval(() => this.update(), CONFIG.WEATHER_UPDATE_INTERVAL);
      }

      async getCoordinates() {
        const params = new URLSearchParams(window.location.search);
        const lat = parseFloat(params.get('lat'));
        const lon = parseFloat(params.get('lon'));

        if (isFinite(lat) && isFinite(lon)) {
          this.state.coords = [lat, lon];
          return;
        }

        if ('geolocation' in navigator) {
          try {
            const position = await this.getCurrentPosition();
            this.state.coords = [position.coords.latitude, position.coords.longitude];
            return;
          } catch (error) {
            console.warn('Geolocation failed:', error);
          }
        }

        // フォールバック
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        this.state.coords = CONFIG.TIMEZONE_COORDS[timezone] || CONFIG.DEFAULT_COORDS;
      }

      getCurrentPosition() {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            resolve,
            reject,
            { timeout: CONFIG.WEATHER_TIMEOUT }
          );
        });
      }

      async update() {
        if (!this.state.coords) return;

        try {
          const [lat, lon] = this.state.coords;
          const url = `${CONFIG.WEATHER_API_URL}?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`;
          
          const response = await fetch(url);
          if (!response.ok) throw new Error('Weather API request failed');
          
          const data = await response.json();
          this.state.weatherData = data;
          this.render(data);
        } catch (error) {
          console.error('Weather update failed:', error);
          this.renderError();
        }
      }

      render(data) {
        const temp = Math.round(data.current?.temperature_2m ?? 0);
        const code = data.current?.weather_code ?? 0;
        const [emoji, description] = this.getWeatherDescription(code);

        this.iconEl.textContent = emoji;
        this.tempEl.textContent = `${temp}°C`;
        this.descEl.textContent = description;
      }

      renderError() {
        this.iconEl.textContent = '⛅';
        this.tempEl.textContent = '--°C';
        this.descEl.textContent = '取得失敗';
      }

      getWeatherDescription(code) {
        const weatherMap = {
          0: ['☀️', '快晴'],
          1: ['🌤', '晴れ'],
          2: ['⛅', '晴れ時々曇り'],
          3: ['☁️', '曇り'],
          45: ['🌫', '霧'],
          48: ['🌫', '濃霧'],
          51: ['🌦', '小雨'],
          53: ['🌦', '雨'],
          55: ['🌧', '本降り'],
          56: ['🌧', 'みぞれ'],
          57: ['🌧', 'みぞれ'],
          61: ['🌦', '小雨'],
          63: ['🌧', '雨'],
          65: ['🌧', '大雨'],
          66: ['🌧', '凍雨'],
          67: ['🌧', '凍雨'],
          71: ['🌨', '小雪'],
          73: ['🌨', '雪'],
          75: ['❄️', '大雪'],
          77: ['❄️', '霰'],
          80: ['🌦', 'にわか雨'],
          81: ['🌧', 'にわか雨'],
          82: ['⛈', '豪雨'],
          85: ['🌨', 'にわか雪'],
          86: ['❄️', 'にわか雪'],
          95: ['⛈', '雷雨'],
          96: ['⛈', '雹を伴う雷雨'],
          99: ['⛈', '雹を伴う雷雨']
        };
        
        return weatherMap[code] || ['⛅', '不明'];
      }
    }

    // 祝日データ管理
    class HolidayManager {
      constructor() {
        this.cache = new Map();
      }

      async getHolidays(year) {
        if (this.cache.has(year)) {
          return this.cache.get(year);
        }

        try {
          const response = await fetch(CONFIG.HOLIDAY_API_URL(year), {
            cache: 'force-cache'
          });
          
          if (!response.ok) throw new Error('Holiday API request failed');
          
          const data = await response.json();
          const holidays = new Map(Object.entries(data));
          this.cache.set(year, holidays);
          
          return holidays;
        } catch (error) {
          console.error('Holiday fetch failed:', error);
          return new Map();
        }
      }
    }

    // カレンダー描画
    class CalendarRenderer {
      constructor(state, holidayManager) {
        this.state = state;
        this.holidayManager = holidayManager;
        this.gridEl = $('#calendar-grid');
        this.titleEl = $('#month-title');
      }

      async render() {
        const { selectedYear: year, selectedMonth: month } = this.state;
        
        // タイトル更新
        this.updateTitle(year, month);
        
        // 祝日データ取得
        const holidays = await this.holidayManager.getHolidays(year);
        
        // グリッド描画
        this.renderGrid(year, month, holidays);
      }

      updateTitle(year, month) {
        const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        const title = `${year}年 ${monthNames[month]}`;
        this.titleEl.textContent = title;
        document.title = `カレンダー - ${title}`;
      }

      renderGrid(year, month, holidays) {
        const today = new Date();
        const isCurrentMonth = (year === today.getFullYear() && month === today.getMonth());
        const todayDate = today.getDate();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // 月曜日始まりに調整
        const startDayOfWeek = (firstDay.getDay() + 6) % 7;
        const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7;

        this.gridEl.innerHTML = '';

        let dayNumber = 1;
        for (let i = 0; i < totalCells; i += 7) {
          const row = document.createElement('tr');
          row.setAttribute('role', 'row');

          for (let j = 0; j < 7; j++) {
            const cellIndex = i + j;
            const td = document.createElement('td');
            td.setAttribute('role', 'gridcell');

            if (cellIndex < startDayOfWeek || dayNumber > daysInMonth) {
              // 空のセル
              const emptyDiv = document.createElement('div');
              emptyDiv.className = 'day empty';
              td.appendChild(emptyDiv);
            } else {
              // 日付セル
              const date = new Date(year, month, dayNumber);
              const dateStr = formatDate(date);
              const dayOfWeek = date.getDay();
              const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
              const holidayInfo = holidays.get(dateStr);
              const isHoliday = !!holidayInfo;
              const isToday = isCurrentMonth && dayNumber === todayDate;

              const dayDiv = this.createDayElement({
                date,
                dayNumber,
                dateStr,
                isWeekend,
                isHoliday,
                isToday,
                holidayName: holidayInfo
              });

              td.appendChild(dayDiv);
              dayNumber++;
            }

            row.appendChild(td);
          }

          this.gridEl.appendChild(row);
        }
      }

      createDayElement(params) {
        const { date, dayNumber, dateStr, isWeekend, isHoliday, isToday, holidayName } = params;

        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';
        if (isWeekend) dayDiv.classList.add('is-weekend');
        if (isHoliday) dayDiv.classList.add('is-holiday');
        if (isToday) dayDiv.classList.add('is-today');

        // リンク要素
        const link = document.createElement('a');
        link.className = 'day-link';
        link.href = CONFIG.APPEND_DATE_QUERY 
          ? `${CONFIG.NOTION_URL}?date=${dateStr}`
          : CONFIG.NOTION_URL;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.setAttribute('aria-label', `${dateStr} をNotionで開く`);
        link.title = `${dateStr} をNotionで開く`;

        // ヘッダー部分
        const header = document.createElement('div');
        header.className = 'day-header';

        const numberSpan = document.createElement('span');
        numberSpan.className = 'day-number';
        numberSpan.textContent = dayNumber;
        header.appendChild(numberSpan);

        // インジケーター（今後の拡張用）
        if (isToday) {
          const indicators = document.createElement('div');
          indicators.className = 'day-indicators';
          const indicator = document.createElement('span');
          indicator.className = 'indicator';
          indicators.appendChild(indicator);
          header.appendChild(indicators);
        }

        // コンテンツ部分
        const content = document.createElement('div');
        content.className = 'day-content';

        if (isHoliday && holidayName) {
          const holidayEl = document.createElement('div');
          holidayEl.className = 'holiday-name';
          holidayEl.textContent = holidayName;
          holidayEl.title = holidayName;
          content.appendChild(holidayEl);
        }

        dayDiv.appendChild(link);
        dayDiv.appendChild(header);
        dayDiv.appendChild(content);

        // キーボードイベント
        dayDiv.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            link.click();
          }
        });

        return dayDiv;
      }
    }

    // メインアプリケーション
    class CalendarApp {
      constructor() {
        this.state = new CalendarState();
        this.clock = new Clock();
        this.weather = new Weather(this.state);
        this.holidayManager = new HolidayManager();
        this.renderer = new CalendarRenderer(this.state, this.holidayManager);
        
        this.initFromURL();
        this.bindEvents();
      }

      initFromURL() {
        const params = new URLSearchParams(window.location.search);
        const year = parseInt(params.get('year'));
        const month = parseInt(params.get('month'));

        if (isFinite(year) && isFinite(month) && month >= 1 && month <= 12) {
          this.state.setYearMonth(year, month - 1);
        }
      }

      bindEvents() {
        // ナビゲーションボタン
        $('#prev-month').addEventListener('click', () => {
          this.state.goToPrevMonth();
          this.renderer.render();
        });

        $('#next-month').addEventListener('click', () => {
          this.state.goToNextMonth();
          this.renderer.render();
        });

        $('#today-btn').addEventListener('click', () => {
          this.state.goToToday();
          this.renderer.render();
        });

        // キーボードショートカット
        document.addEventListener('keydown', (e) => {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

          switch(e.key) {
            case 'ArrowLeft':
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                this.state.goToPrevMonth();
                this.renderer.render();
              }
              break;
            case 'ArrowRight':
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                this.state.goToNextMonth();
                this.renderer.render();
              }
              break;
            case 't':
            case 'T':
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                this.state.goToToday();
                this.renderer.render();
              }
              break;
          }
        });

        // ページ可視性の変更を監視
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            this.clock.stop();
          } else {
            this.clock.start();
            this.weather.update();
          }
        });

        // ウィンドウリサイズの最適化
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            this.renderer.render();
          }, 250);
        });

        // オンライン/オフライン状態の監視
        window.addEventListener('online', () => {
          this.weather.update();
          this.renderer.render();
        });

        window.addEventListener('offline', () => {
          ErrorHandler.show('オフラインです。一部の機能が制限されます。');
        });
      }

      async init() {
        try {
          // ローディング表示
          this.showLoading();

          // 各コンポーネントの初期化
          this.clock.start();
          await this.weather.init();
          await this.renderer.render();

          // ローディング非表示
          this.hideLoading();

          // サービスワーカーの登録（PWA対応）
          this.registerServiceWorker();

        } catch (error) {
          console.error('Initialization failed:', error);
          ErrorHandler.show('初期化に失敗しました。ページを再読み込みしてください。');
          this.hideLoading();
        }
      }

      showLoading() {
        const loader = document.createElement('div');
        loader.id = 'init-loader';
        loader.className = 'loading';
        loader.innerHTML = '<span class="spinner"></span><span>初期化中...</span>';
        $('#calendar-grid').innerHTML = '';
        $('#calendar-grid').appendChild(loader);
      }

      hideLoading() {
        const loader = $('#init-loader');
        if (loader) {
          loader.remove();
        }
      }

      registerServiceWorker() {
        if ('serviceWorker' in navigator && location.protocol === 'https:') {
          // 本番環境でのみService Workerを登録
          // navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
      }
    }

    // アプリケーション起動
    document.addEventListener('DOMContentLoaded', () => {
      const app = new CalendarApp();
      app.init().catch(error => {
        console.error('Failed to initialize app:', error);
        ErrorHandler.show('アプリケーションの起動に失敗しました。');
      });
    });

    // グローバルエラーハンドラ
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      ErrorHandler.show('予期しないエラーが発生しました。');
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      ErrorHandler.show('処理中にエラーが発生しました。');
    });
  </script>
</body>
</html>
