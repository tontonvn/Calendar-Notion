<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendar Widget for Notion</title>
  <style>
    :root{
      --bg:#ffffff;--fg:#111111;--muted:#6b7280;--accent:#111111;--today-bg:#111111;--today-fg:#ffffff;--danger:#c1121f;
      --card:#f7f7f8;--card2:#f0f1f3;--ring:#e5e7eb;--shadow:0 8px 24px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Yu Gothic",Meiryo,Helvetica,Arial,sans-serif; 
      color:var(--fg);background:var(--bg);
      font-variant-numeric: tabular-nums; /* Êï∞Â≠ó„ÅÆÂπÖ„ÇíÂùáÁ≠â„Å´ */
    }
    .widget{max-width:840px;margin:0 auto;padding:12px 14px;display:flex;flex-direction:column;gap:12px}

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border:1px solid var(--ring);border-radius:16px;background:var(--card);box-shadow:var(--shadow)}
    .clock{font-weight:700;font-size:18px;letter-spacing:.2px}
    .subtle{color:var(--muted);font-weight:500}
    .weather{display:flex;align-items:center;gap:10px;font-weight:600}
    .weather .meta{display:flex;flex-direction:column;line-height:1.2}
    .weather .meta span{font-size:12px;color:var(--muted);font-weight:500}

    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .monthnav{display:flex;align-items:center;gap:6px}
    .btn{background:var(--card2);border:1px solid var(--ring);border-radius:12px;padding:6px 10px;cursor:pointer;user-select:none;font-weight:600}
    .btn:hover{filter:brightness(0.98)}
    .title{font-weight:800;font-size:18px}
    .todaylink{font-weight:600;text-decoration:underline;cursor:pointer}

    /* ==== „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÁ¥îÁ≤ã„Å™table„ÅßÊèÉ„Åà„Çã ==== */
    .calendar{width:100%;border-collapse:separate;border-spacing:6px} /* Ë°å„ÉªÂàó„Å©„Å°„Çâ„ÇÇÈñìÈöî */
    .calendar thead th{ text-align:center;padding:8px 0;color:var(--muted);font-weight:700;letter-spacing:.4px }
    .calendar td{ vertical-align:top }

    .day{position:relative;aspect-ratio:1/1.05;background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:8px;display:flex;flex-direction:column;gap:8px;justify-content:flex-start;align-items:flex-start;overflow:hidden;width:100%}
    .day.empty{background:transparent;border-color:transparent}

    .date{ display:inline-flex; align-items:center; justify-content:center; 
      min-width:2ch; /* ‰∏ÄÊ°Å/‰∫åÊ°Å„ÅßÂπÖ„ÅåÊèÉ„ÅÜ */
      font-weight:800;font-size:16px;line-height:1; border-radius:10px; padding:4px 6px; color:var(--fg)
    }

    .day a.overlay{ position:absolute; inset:0; border-radius:inherit; text-decoration:none }
    .day:hover{ outline:2px solid rgba(0,0,0,.06) }
    .is-weekend .date, .is-holiday .date{ color:var(--danger) }
    .is-today .date{ background:var(--today-bg); color:var(--today-fg) }

    .legend{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:12px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;background:var(--fg)}
    .dot.red{background:var(--danger)}

    @media (max-width:540px){
      .clock{font-size:16px}
      .topbar{border-radius:12px}
      .day{padding:6px;border-radius:12px}
      .date{font-size:14px}
    }
  </style>
</head>
<body>
  <div class="widget" id="app">
    <div class="topbar">
      <div>
        <div class="clock" id="clock">--:--:--</div>
        <div class="subtle" id="tz"></div>
      </div>
      <div class="weather" id="weather">
        <div class="icon" id="wicon" aria-hidden="true">‚õÖ</div>
        <div class="meta">
          <strong id="wtemp">--¬∞C</strong>
          <span id="wdesc">Loading weather‚Ä¶</span>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <div class="monthnav">
        <button class="btn" id="prev">‚óÄ</button>
        <div class="title" id="title">Month YYYY</div>
        <button class="btn" id="next">‚ñ∂</button>
      </div>
      <div class="legend">
        <span><i class="dot"></i>Weekday</span>
        <span><i class="dot red"></i>Weekend & Holiday</span>
        <span class="todaylink" id="gotoday">Today</span>
      </div>
    </div>

    <table class="calendar" aria-label="Monthly calendar">
      <thead>
        <tr>
          <th>Mon</th>
          <th>Tue</th>
          <th>Wed</th>
          <th>Thu</th>
          <th>Fri</th>
          <th style="color:var(--danger)">Sat</th>
          <th style="color:var(--danger)">Sun</th>
        </tr>
      </thead>
      <tbody id="grid"></tbody>
    </table>
  </div>

<script>
const CONFIG = {
  NOTION_CALENDAR_URL: "https://www.notion.so/your-calendar-page",
  APP_TITLE_PREFIX: "",
  APPEND_DATE_QUERY: true,
  JP_HOLIDAY_URL: (year)=>`https://holidays-jp.github.io/api/v1/${year}/date.json`,
};

const $ = (s)=>document.querySelector(s);
const pad = (n)=>String(n).padStart(2,'0');

function startClock(){
  const clock = $('#clock');
  const tz = $('#tz');
  const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
  tz.textContent = tzName + ' ‚Ä¢ 24-hour time';
  const tick = ()=>{
    const d = new Date();
    clock.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };
  tick();
  setInterval(tick, 1000);
}

function wmoToEmojiDesc(code){
  const MAP = {
    0:['‚òÄÔ∏è','Clear'],1:['üå§','Mainly clear'],2:['‚õÖ','Partly cloudy'],3:['‚òÅÔ∏è','Overcast'],
    45:['üå´','Fog'],48:['üå´','Depositing rime fog'],
    51:['üå¶','Light drizzle'],53:['üå¶','Drizzle'],55:['üåß','Dense drizzle'],
    56:['üåß','Freezing drizzle'],57:['üåß','Freezing drizzle'],
    61:['üå¶','Slight rain'],63:['üåß','Rain'],65:['üåß','Heavy rain'],
    66:['üåß','Freezing rain'],67:['üåß','Freezing rain'],
    71:['üå®','Slight snow'],73:['üå®','Snow'],75:['‚ùÑÔ∏è','Heavy snow'],
    77:['‚ùÑÔ∏è','Snow grains'],
    80:['üå¶','Rain showers'],81:['üåß','Rain showers'],82:['‚õà','Violent rain showers'],
    85:['üå®','Snow showers'],86:['‚ùÑÔ∏è','Snow showers'],
    95:['‚õà','Thunderstorm'],96:['‚õà','Thunderstorm hail'],99:['‚õà','Thunderstorm hail']
  };
  return MAP[code] || ['‚õÖ','Weather'];
}

function parseQuery(){
  const p = new URLSearchParams(location.search);
  const lat = parseFloat(p.get('lat'));
  const lon = parseFloat(p.get('lon'));
  const y = parseInt(p.get('year'));
  const m = parseInt(p.get('month'));
  return { lat: isFinite(lat)?lat:null, lon: isFinite(lon)?lon:null, year: isFinite(y)?y:null, month: isFinite(m)?m:null };
}

function tzFallbackCoords(){
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
  const table = {
    'Asia/Tokyo':[35.681236,139.767125],
    'Asia/Seoul':[37.5665,126.9780],
    'Asia/Taipei':[25.0375,121.5637],
    'Asia/Shanghai':[31.2304,121.4737],
    'Asia/Hong_Kong':[22.3193,114.1694],
    'America/Los_Angeles':[34.0522,-118.2437],
    'America/New_York':[40.7128,-74.006],
    'Europe/London':[51.5074,-0.1278],
    'Europe/Paris':[48.8566,2.3522]
  };
  return table[tz] || [35.681236,139.767125];
}

async function loadWeather(){
  const {lat:qlat, lon:qlon} = parseQuery();
  const setUI=(t, desc, emoji)=>{
    $('#wtemp').textContent = `${Math.round(t)}¬∞C`;
    $('#wdesc').textContent = desc;
    $('#wicon').textContent = emoji;
  };
  async function fetchWeather(lat,lon){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('weather fetch failed');
    const j = await r.json();
    const code = j.current?.weather_code ?? 0;
    const [emoji, desc] = wmoToEmojiDesc(code);
    setUI(j.current?.temperature_2m ?? NaN, desc, emoji);
  }
  function withFallback(){
    const [lat,lon] = qlat && qlon ? [qlat, qlon] : tzFallbackCoords();
    return fetchWeather(lat,lon).catch(()=>setUI(NaN,'Weather unavailable','‚õÖ'));
  }
  if(qlat && qlon){ return withFallback(); }
  if(!('geolocation' in navigator)) return withFallback();
  return new Promise((resolve)=>{
    const done = ()=>resolve();
    navigator.geolocation.getCurrentPosition(async(pos)=>{
      const {latitude,longitude} = pos.coords;
      try{ await fetchWeather(latitude,longitude);}catch{ setUI(NaN,'Weather unavailable','‚õÖ'); }
      done();
    }, async()=>{ await withFallback(); done(); }, {timeout: 2500});
  });
}

async function fetchJPHolidays(year){
  const url = CONFIG.JP_HOLIDAY_URL(year);
  try{
    const r = await fetch(url, {cache:'force-cache'});
    if(!r.ok) throw new Error('holiday fetch failed');
    const data = await r.json();
    return new Set(Object.keys(data));
  }catch(e){
    console.warn('Holiday fetch failed; weekends only as holiday.', e);
    return new Set();
  }
}

let current = (()=>{
  const q = parseQuery();
  const base = q.year && q.month ? new Date(q.year, q.month-1, 1) : new Date();
  return new Date(base.getFullYear(), base.getMonth(), 1);
})();
let holidayCache = new Map();

function ymd(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
function isWeekend(d){ const wd = d.getDay(); return wd===0 || wd===6; }
function mondayIndex(date){ return (date.getDay()+6)%7; }

async function render(){
  const year = current.getFullYear();
  const month = current.getMonth();
  const title = `${CONFIG.APP_TITLE_PREFIX}${year}Âπ¥ ${month+1}Êúà`;
  document.title = title;
  $('#title').textContent = title;

  let holidays = holidayCache.get(year);
  if(!holidays){ holidays = await fetchJPHolidays(year); holidayCache.set(year, holidays); }

  const first = new Date(year, month, 1);
  const last  = new Date(year, month+1, 0);
  const daysInMonth = last.getDate();
  const grid = $('#grid');
  grid.innerHTML = '';

  const today = new Date();
  const isThisMonth = (today.getFullYear()===year && today.getMonth()===month);

  const leadEmpty = mondayIndex(first);
  const totalCells = leadEmpty + daysInMonth;
  const rows = Math.ceil(totalCells/7);

  let dayNum = 1;
  for(let r=0;r<rows;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<7;c++){
      const td = document.createElement('td');
      const idx = r*7 + c;
      if(idx>=leadEmpty && dayNum<=daysInMonth){
        const d = new Date(year, month, dayNum);
        const key = ymd(d);
        const weekend = isWeekend(d);
        const holiday = holidays.has(key);

        const box = document.createElement('div');
        box.className = 'day' + (weekend?' is-weekend':'') + (holiday?' is-holiday':'');

        const dateSpan = document.createElement('div');
        dateSpan.className = 'date';
        dateSpan.textContent = dayNum;
        box.appendChild(dateSpan);

        if(isThisMonth && dayNum===today.getDate()){
          box.classList.add('is-today');
        }

        const a = document.createElement('a');
        a.className = 'overlay';
        const base = CONFIG.NOTION_CALENDAR_URL || location.href;
        a.href = CONFIG.APPEND_DATE_QUERY ? `${base}?q=${key}` : base;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.title = `${key} „ÇíNotion„ÅßÈñã„Åè`;
        box.appendChild(a);

        td.appendChild(box);
        dayNum++;
      }else{
        const box = document.createElement('div');
        box.className = 'day empty';
        td.appendChild(box);
      }
      tr.appendChild(td);
    }
    grid.appendChild(tr);
  }
}

$('#prev').addEventListener('click',()=>{ current = new Date(current.getFullYear(), current.getMonth()-1, 1); render(); });
$('#next').addEventListener('click',()=>{ current = new Date(current.getFullYear(), current.getMonth()+1, 1); render(); });
$('#gotoday').addEventListener('click',()=>{ current = new Date(new Date().getFullYear(), new Date().getMonth(), 1); render(); });

(async function init(){
  startClock();
  await loadWeather();
  await render();
})();
</script>
</body>
</html>
